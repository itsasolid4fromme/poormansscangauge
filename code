#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// Analog input pins
const int MAP_PIN = A0;
const int IAT_PIN = A1;
const int OIL_PIN = A2;

// MAP sensor: 0.5–4.5V = 0–4 bar
const float MAP_VOLTAGE_MIN = 0.5;
const float MAP_VOLTAGE_MAX = 4.5;
const float MAP_PRESSURE_MAX = 4.0;
const float ATM_PRESS_BAR = 1.0;

// Oil pressure sensor: 0.5–4.5V = 0–100 PSI
const float OIL_VOLT_MIN = 0.5;
const float OIL_VOLT_MAX = 4.5;
const float OIL_PRESS_MAX = 100.0;

// Timing
const unsigned long updateInterval = 500;
const unsigned long peakResetInterval = 30000;

unsigned long lastUpdate = 0;
unsigned long lastPeakUpdate = 0;
float peakBoostPSI = 0.0;

void setup() {
  Serial.begin(9600);
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    while (true);  // freeze if OLED fails
  }

  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);
  display.setTextSize(1);
  display.setCursor(10, 20);
  display.println("Boost Display Init");
  display.display();
  delay(2000);
  display.clearDisplay();
}

void loop() {
  unsigned long now = millis();
  if (now - lastUpdate >= updateInterval) {
    lastUpdate = now;

    // --- Boost PSI ---
    float mapV = analogRead(MAP_PIN) * 5.0 / 1023.0;
    float mapBar = ((mapV - MAP_VOLTAGE_MIN) / (MAP_VOLTAGE_MAX - MAP_VOLTAGE_MIN)) * MAP_PRESSURE_MAX;
    float boostBar = mapBar - ATM_PRESS_BAR;
    float boostPSI = boostBar * 14.5038;
    if (boostPSI < 0) boostPSI = 0;

    // --- Peak tracking ---
    if (boostPSI > peakBoostPSI) {
      peakBoostPSI = boostPSI;
      lastPeakUpdate = now;
    }
    if (now - lastPeakUpdate >= peakResetInterval) {
      peakBoostPSI = 0;
    }

    // --- IAT °F ---
    float iatV = analogRead(IAT_PIN) * 5.0 / 1023.0;
    float iatC = (iatV - 0.5) * 100.0;
    float iatF = iatC * 9.0 / 5.0 + 32.0;
    if (iatF < -40) iatF = -40;
    if (iatF > 300) iatF = 300;

    // --- Oil PSI ---
    float oilV = analogRead(OIL_PIN) * 5.0 / 1023.0;
    float oilPSI = ((oilV - OIL_VOLT_MIN) / (OIL_VOLT_MAX - OIL_VOLT_MIN)) * OIL_PRESS_MAX;
    if (oilPSI < 0) oilPSI = 0;

    // --- Display ---
    display.clearDisplay();
    display.setTextColor(SSD1306_WHITE);
    display.setTextSize(1);

    // Top row: PSI and PK
    display.setCursor(0, 0);
    display.print("PSI ");
    display.print(boostPSI, 0);

    display.setCursor(64, 0);
    display.print("PK ");
    display.print(peakBoostPSI, 0);

    // Bottom row: IAT and OIL
    display.setCursor(0, 24);
    display.print("IAT ");
    display.print(iatF, 0);
    display.print((char)247);
    display.print("F");

    display.setCursor(64, 24);
    display.print("OIL ");
    display.print(oilPSI, 0);

    display.display();

    // Debug (optional)
    Serial.print("Boost: ");
    Serial.print(boostPSI);
    Serial.print(" PSI | PK: ");
    Serial.print(peakBoostPSI);
    Serial.print(" | IAT: ");
    Serial.print(iatF);
    Serial.print(" F | OIL: ");
    Serial.println(oilPSI);
  }
}
